     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern SquareSPHERE
     6                                  extern SquarePARALLELEPIPED
     7                                  extern SquareTETRAHEDRON
     8                                  
     9                                  extern SPHERE
    10                                  extern PARALLELEPIPED
    11                                  extern TETRAHEDRON
    12                                  
    13                                  
    14                                  global OutSPHERE
    15                                  OutSPHERE:
    16                                  section .data
    17 00000000 497420697320535048-         .outfmt db "It is SPHERE: x = %d, density = %d. Square = %f",10,0
    17 00000009 4552453A2078203D20-
    17 00000012 25642C2064656E7369-
    17 0000001B 7479203D2025642E20-
    17 00000024 537175617265203D20-
    17 0000002D 25660A00           
    18                                  section .bss
    19 00000000 ????????????????            .prect  resq  1
    20 00000008 ????????????????            .FILE   resq  1       ; временное хранение указателя на файл
    21 00000010 ????????????????            .p      resq  1       ; вычисленный периметр прямоугольника
    22                                  section .text
    23 00000000 55                      push rbp
    24 00000001 4889E5                  mov rbp, rsp
    25                                  
    26                                      ; Сохранени принятых аргументов
    27 00000004 48893C25[00000000]          mov     [.prect], rdi          ; сохраняется адрес прямоугольника
    28 0000000C 48893425[08000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    29                                  
    30                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
    31 00000014 E8(00000000)                call    SquareSPHERE
    32 00000019 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    32 0000001E [10000000]         
    33                                  
    34                                      ; Вывод информации о прямоугольнике в файл
    35 00000022 488B3C25[08000000]          mov     rdi, [.FILE]
    36 0000002A 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    36 0000002C [0000000000000000] 
    37 00000034 488B0425[00000000]          mov     rax, [.prect]        ; адрес прямоугольника
    38 0000003C 8B10                        mov     edx, [rax]          ; x
    39 0000003E 8B4804                      mov     ecx, [rax+4] 
    40                                      ;movsd   xmm1, [.prect]       ; density
    41 00000041 F20F100425-                 movsd   xmm0, [.p]
    41 00000046 [10000000]         
    42 0000004A B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    43 0000004F E8(00000000)                call    fprintf
    44                                  
    45 00000054 C9                      leave
    46 00000055 C3                      ret
    47                                  
    48                                  
    49                                  global OutPARALLELEPIPED
    50                                  OutPARALLELEPIPED:
    51                                  section .data
    52 00000031 497420697320504152-         .outfmt db "It is PARALLELEPIPED: a = %d, b = %d, c = %d, density = %d. Square = %f",10,0
    52 0000003A 414C4C454C45504950-
    52 00000043 45443A2061203D2025-
    52 0000004C 642C2062203D202564-
    52 00000055 2C2063203D2025642C-
    52 0000005E 2064656E7369747920-
    52 00000067 3D2025642E20537175-
    52 00000070 617265203D2025660A-
    52 00000079 00                 
    53                                  section .bss
    54 00000018 ????????????????            .ptrian  resq  1
    55 00000020 ????????????????            .FILE   resq  1       ; временное хранение указателя на файл
    56 00000028 ????????????????            .p      resq  1       ; вычисленный периметр треугольника
    57                                  section .text
    58 00000056 55                      push rbp
    59 00000057 4889E5                  mov rbp, rsp
    60                                  
    61                                      ; Сохранени принятых аргументов
    62 0000005A 48893C25[18000000]          mov     [.ptrian], rdi        ; сохраняется адрес треугольника
    63 00000062 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    64                                  
    65                                      ; Вычисление периметра треугольника (адрес уже в rdi)
    66 0000006A E8(00000000)                call    SquarePARALLELEPIPED
    67 0000006F F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
    67 00000074 [28000000]         
    68                                  
    69                                  
    70                                      ; Вывод информации о треугольнике в файл
    71 00000078 488B3C25[20000000]          mov     rdi, [.FILE]
    72 00000080 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    72 00000082 [3100000000000000] 
    73 0000008A 488B0425[18000000]          mov     rax, [.ptrian]      ; адрес треугольника
    74 00000092 8B10                        mov     edx, [rax]          ; a
    75 00000094 8B4804                      mov     ecx, [rax+4]        ; b
    76 00000097 4C8B4008                    mov      r8, [rax+8]        ; c
    77 0000009B 4C8B480C                    mov     r9, [rax+12]        ; density
    78                                      ;movsd   xmm1, [rax+12]
    79 0000009F F20F100425-                 movsd   xmm0, [.p]
    79 000000A4 [28000000]         
    80 000000A8 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    81 000000AD E8(00000000)                call    fprintf
    82                                  
    83 000000B2 C9                      leave
    84 000000B3 C3                      ret
    85                                  
    86                                  global OutTETRAHEDRON
    87                                  OutTETRAHEDRON:
    88                                  section .data
    89 0000007A 497420697320544554-         .outfmt db "It is TETRAHEDRON: x = %d, density = %d. Square = %f",10,0
    89 00000083 5241484544524F4E3A-
    89 0000008C 2078203D2025642C20-
    89 00000095 64656E73697479203D-
    89 0000009E 2025642E2053717561-
    89 000000A7 7265203D2025660A00 
    90                                  section .bss
    91 00000030 ????????????????            .tetrah  resq  1
    92 00000038 ????????????????            .FILE   resq  1       ; временное хранение указателя на файл
    93 00000040 ????????????????            .p      resq  1       ; вычисленный периметр прямоугольника
    94                                  section .text
    95 000000B4 55                      push rbp
    96 000000B5 4889E5                  mov rbp, rsp
    97                                  
    98                                      ; Сохранени принятых аргументов
    99 000000B8 48893C25[30000000]          mov     [.tetrah], rdi          ; сохраняется адрес прямоугольника
   100 000000C0 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   101                                  
   102                                      ; Вычисление периметра прямоугольника (адрес уже в rdi)
   103 000000C8 E8(00000000)                call    SquareTETRAHEDRON
   104 000000CD F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) периметра
   104 000000D2 [40000000]         
   105                                  
   106 000000D6 488B3C25[38000000]          mov     rdi, [.FILE]
   107 000000DE 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   107 000000E0 [7A00000000000000] 
   108 000000E8 488B0425[30000000]          mov     rax, [.tetrah]        ; адрес прямоугольника
   109 000000F0 8B10                        mov     edx, [rax]          ; x
   110 000000F2 8B4804                      mov     ecx, [rax+4] 
   111 000000F5 F20F100425-                 movsd   xmm0, [.p]
   111 000000FA [40000000]         
   112 000000FE B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   113 00000103 E8(00000000)                call    fprintf
   114                                  
   115 00000108 C9                      leave
   116 00000109 C3                      ret
   117                                  
   118                                  
   119                                  global OutShape
   120                                  OutShape:
   121                                  section .data
   122 000000B0 496E636F7272656374-         .erShape db "Incorrect figure!",10,0
   122 000000B9 20666967757265210A-
   122 000000C2 00                 
   123                                  section .text
   124 0000010A 55                      push rbp
   125 0000010B 4889E5                  mov rbp, rsp
   126                                  
   127                                      ; В rdi адрес фигуры
   128 0000010E 8B07                        mov eax, [rdi]
   129 00000110 3B0425[00000000]            cmp eax, [SPHERE]
   130 00000117 7428                        je sphereOut
   131 00000119 3B0425[00000000]            cmp eax, [PARALLELEPIPED]
   132 00000120 742A                        je parallelOut
   133 00000122 3B0425[00000000]            cmp eax, [TETRAHEDRON]
   134 00000129 742C                        je tetrahOut
   135 0000012B 48BF-                       mov rdi, .erShape
   135 0000012D [B000000000000000] 
   136 00000135 B800000000                  mov rax, 0
   137 0000013A E8(00000000)                call fprintf
   138 0000013F EB1F                        jmp     return
   139                                  sphereOut:
   140                                      ; Вывод прямоугольника
   141 00000141 4883C704                    add     rdi, 4
   142 00000145 E8B6FEFFFF                  call    OutSPHERE
   143 0000014A EB14                        jmp     return
   144                                  
   145                                  parallelOut:
   146                                      ; Вывод треугольника
   147 0000014C 4883C704                    add     rdi, 4
   148 00000150 E801FFFFFF                  call    OutPARALLELEPIPED
   149 00000155 EB09                        jmp     return
   150                                  
   151                                  tetrahOut:
   152 00000157 4883C704                    add     rdi, 4
   153 0000015B E854FFFFFF                  call    OutTETRAHEDRON
   154                                  return:
   155 00000160 C9                      leave
   156 00000161 C3                      ret
   157                                  
   158                                  
   159                                  global OutContainer
   160                                  OutContainer:
   161                                  section .data
   162 000000C3 25643A2000                  numFmt  db  "%d: ",0
   163                                  section .bss
   164 00000048 ????????????????            .pcont  resq    1   ; адрес контейнера
   165 00000050 ????????                    .len    resd    1   ; адрес для сохранения числа введенных элементов
   166 00000054 ????????????????            .FILE   resq    1   ; указатель на файл
   167                                  section .text
   168 00000162 55                      push rbp
   169 00000163 4889E5                  mov rbp, rsp
   170                                  
   171 00000166 48893C25[48000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   172 0000016E 893425[50000000]            mov [.len],   esi     ; сохраняется число элементов
   173 00000175 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   174                                  
   175                                      ; В rdi адрес начала контейнера
   176 0000017D 4889F3                      mov rbx, rsi            ; число фигур
   177 00000180 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   178 00000182 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   179                                  .loop:
   180 00000185 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   181 00000187 7D4D                        jge .return             ; Перебрали все фигуры
   182                                  
   183 00000189 53                          push rbx
   184 0000018A 51                          push rcx
   185                                  
   186                                      ; Вывод номера фигуры
   187 0000018B 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   188 00000193 48BE-                       mov     rsi, numFmt     ; формат для вывода фигуры
   188 00000195 [C300000000000000] 
   189 0000019D 89CA                        mov     edx, ecx        ; индекс текущей фигуры
   190 0000019F 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   191 000001A2 E8(00000000)                call fprintf
   192                                  
   193                                      ; Вывод текущей фигуры
   194 000001A7 488B3C25[48000000]          mov     rdi, [.pcont]
   195 000001AF 488B3425[54000000]          mov     rsi, [.FILE]
   196 000001B7 E84EFFFFFF                  call OutShape     ; Получение периметра первой фигуры
   197                                  
   198 000001BC 59                          pop rcx
   199 000001BD 5B                          pop rbx
   200 000001BE FFC1                        inc ecx                 ; индекс следующей фигуры
   201                                  
   202 000001C0 488B0425[48000000]          mov     rax, [.pcont]
   203 000001C8 4883C020                    add     rax, 32        ; адрес следующей фигуры
   204 000001CC 48890425[48000000]          mov     [.pcont], rax
   205 000001D4 EBAF                        jmp .loop
   206                                  .return:
   207 000001D6 C9                      leave
   208 000001D7 C3                      ret
   209                                  
