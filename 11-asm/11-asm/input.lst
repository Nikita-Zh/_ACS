     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  
     5                                  extern SPHERE
     6                                  extern PARALLELEPIPED
     7                                  extern TETRAHEDRON
     8                                  
     9                                  ;----------------------------------------------
    10                                  ; // Ввод параметров прямоугольника из файла
    11                                  ; void InSPHERE(void *r, FILE *ifst) {
    12                                  ;     fscanf(ifst, "%d%d", (int*)r, (int*)(r+intSize));
    13                                  ; }
    14                                  global InSPHERE
    15                                  InSPHERE:
    16                                  section .data
    17 00000000 2564256400                  .infmt db "%d%d",0
    18                                  
    19                                  section .bss
    20 00000000 ????????????????            .FILE   resq    1   ; временное хранение указателя на файл
    21 00000008 ????????????????            .sphere  resq    1   ; адрес прямоугольника
    22                                  
    23                                  section .text
    24 00000000 55                      push rbp
    25 00000001 4889E5                  mov rbp, rsp
    26                                  
    27                                      ; Сохранение принятых аргументов
    28 00000004 48893C25[08000000]          mov     [.sphere], rdi          ; сохраняется адрес cферы
    29 0000000C 48893425[00000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    30                                  
    31                                      ; Ввод прямоугольника из файла
    32 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    33 0000001C 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    33 0000001E [0000000000000000] 
    34 00000026 488B1425[08000000]          mov     rdx, [.sphere]       ; &x
    35 0000002E 488B0C25[08000000]          mov     rcx, [.sphere]
    36 00000036 4883C104                    add     rcx, 4          ; &density
    37 0000003A B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    38 0000003F E8(00000000)                call    fscanf
    39                                  
    40                                      ;mov     rdi, [.FILE]
    41                                      ;mov     rsi, .infmt         ; Формат - 1-й аргумент
    42                                      ;mov     rdx, [.sphere]       ; &x
    43                                      ;movsd   xmm0, [.sphere]
    44                                      ;xadd   xmm0, 8
    45                                      ;mov     rcx, [.sphere]
    46                                      ;add     rcx, 4          ; &density
    47                                      ;cvtsi2sd xmm1, rcx
    48                                     ; mov     rax, 1            ; нет чисел с плавающей точкой
    49                                      ;call    fscanf
    50                                  
    51                                      
    52                                      ;lea rdx, .x
    53                                      ;push rdx
    54                                      ;lea rdx, .density
    55                                      ;push rdx
    56                                      ;lea rdx, .infmt
    57                                      ;push rdx
    58                                      ;mov rdx, 0
    59                                      ;push rdx
    60                                      ;call    fscanf
    61                                  
    62 00000044 C9                      leave
    63 00000045 C3                      ret
    64                                  
    65                                  ; // Ввод параметров треугольника из файла
    66                                  ; void InPARALLELEPIPED(void *t, FILE *ifst) {
    67                                  ;     fscanf(ifst, "%d%d%d", (int*)t,
    68                                  ;            (int*)(t+intSize), (int*)(t+2*intSize));
    69                                  ; }
    70                                  global InPARALLELEPIPED
    71                                  InPARALLELEPIPED:
    72                                  section .data
    73 00000005 256425642564256400          .infmt db "%d%d%d%d",0
    74                                  section .bss
    75 00000010 ????????????????            .FILE   resq    1   ; временное хранение указателя на файл
    76 00000018 ????????????????            .parall  resq    1   ; адрес треугольника
    77                                  section .text
    78 00000046 55                      push rbp
    79 00000047 4889E5                  mov rbp, rsp
    80                                  
    81                                      ; Сохранение принятых аргументов
    82 0000004A 48893C25[18000000]          mov     [.parall], rdi          ; сохраняется адрес треугольника
    83 00000052 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    84                                  
    85                                      ; Ввод треугольника из файла
    86 0000005A 488B3C25[10000000]          mov     rdi, [.FILE]
    87 00000062 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    87 00000064 [0500000000000000] 
    88                                  
    89 0000006C 488B1425[18000000]          mov     rdx, [.parall]       ; &a
    90                                  
    91 00000074 488B0C25[18000000]          mov     rcx, [.parall]
    92 0000007C 4883C104                    add     rcx, 4              ; &b = &a + 4
    93                                  
    94 00000080 4C8B0425[18000000]          mov     r8, [.parall]
    95 00000088 4983C008                    add     r8, 8               ; &c = &a + 8
    96                                  
    97 0000008C 4C8B0C25[18000000]          mov     r9, [.parall]
    98 00000094 4983C10C                    add     r9, 12
    99                                      ;movsd     xmm1, [.trian]
   100                                      ;add     xmm1, 12
   101 00000098 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
   102 0000009D E8(00000000)                call    fscanf
   103                                  
   104 000000A2 C9                      leave
   105 000000A3 C3                      ret
   106                                  
   107                                  global InTETRAHEDRON
   108                                  InTETRAHEDRON:
   109                                  section .data
   110 0000000E 2564256400                  .infmt db "%d%d",0
   111                                  section .bss
   112 00000020 ????????????????            .FILE   resq    1   ; временное хранение указателя на файл
   113 00000028 ????????????????            .tetrah  resq    1   ; адрес треугольника
   114                                  section .text
   115 000000A4 55                      push rbp
   116 000000A5 4889E5                  mov rbp, rsp
   117                                  
   118                                      ; Сохранение принятых аргументов
   119 000000A8 48893C25[28000000]          mov     [.tetrah], rdi          ; сохраняется адрес cферы
   120 000000B0 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   121                                  
   122                                      ; Ввод прямоугольника из файла
   123 000000B8 488B3C25[20000000]          mov     rdi, [.FILE]
   124 000000C0 48BE-                       mov     rsi, .infmt        
   124 000000C2 [0E00000000000000] 
   125 000000CA 488B1425[28000000]          mov     rdx, [.tetrah]   
   126 000000D2 488B0C25[28000000]          mov     rcx, [.tetrah]
   127 000000DA 4883C104                    add     rcx, 4        
   128 000000DE B800000000                  mov     rax, 0   
   129 000000E3 E8(00000000)                call    fscanf
   130                                  
   131 000000E8 C9                      leave
   132 000000E9 C3                      ret
   133                                  
   134                                  
   135                                  global InShape
   136                                  InShape:
   137                                  section .data
   138 00000013 256400                      .tagFormat   db      "%d",0
   139 00000016 5461672069733A2025-         .tagOutFmt   db     "Tag is: %d",10,0
   139 0000001F 640A00             
   140                                  section .bss
   141 00000030 ????????????????            .FILE       resq    1   ; временное хранение указателя на файл
   142 00000038 ????????????????            .pshape     resq    1   ; адрес фигуры
   143 00000040 ????????                    .shapeTag   resd    1   ; признак фигуры
   144                                  section .text
   145 000000EA 55                      push rbp
   146 000000EB 4889E5                  mov rbp, rsp
   147                                  
   148                                      ; Сохранение принятых аргументов
   149 000000EE 48893C25[38000000]          mov     [.pshape], rdi          ; сохраняется адрес фигуры
   150 000000F6 48893425[30000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   151                                  
   152                                      ; чтение признака фигуры и его обработка
   153 000000FE 488B3C25[30000000]          mov     rdi, [.FILE]
   154 00000106 48BE-                       mov     rsi, .tagFormat
   154 00000108 [1300000000000000] 
   155 00000110 488B1425[38000000]          mov     rdx, [.pshape]      ; адрес начала фигуры (ее признак)
   156 00000118 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   157 0000011B E8(00000000)                call    fscanf
   158                                  
   159                                      ; Тестовый вывод признака фигуры
   160                                      ;mov     rdi, .tagOutFmt
   161                                      ;mov     rax, [.pshape]
   162                                      ;mov     esi, [rax]
   163                                      ;call    printf
   164                                  
   165 00000120 488B0C25[38000000]          mov rcx, [.pshape]          ; загрузка адреса начала фигуры
   166 00000128 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   167 0000012A 3B0425[00000000]            cmp eax, [SPHERE]
   168 00000131 7416                        je .sphereIn
   169 00000133 3B0425[00000000]            cmp eax, [PARALLELEPIPED]
   170 0000013A 742D                        je .parallelepipedIn
   171 0000013C 3B0425[00000000]            cmp eax, [TETRAHEDRON]
   172 00000143 7444                        je .tetrahedronIn
   173 00000145 31C0                        xor eax, eax    ; Некорректный признак - обнуление кода возврата
   174 00000147 EB5E                        jmp     .return
   175                                  
   176                                  .sphereIn:
   177 00000149 488B3C25[38000000]          mov     rdi, [.pshape]
   178 00000151 4883C704                    add     rdi, 4
   179 00000155 488B3425[30000000]          mov     rsi, [.FILE]
   180 0000015D E89EFEFFFF                  call    InSPHERE
   181 00000162 B801000000                  mov     rax, 1  ; Код возврата - true
   182 00000167 EB3E                        jmp     .return
   183                                  
   184                                  .parallelepipedIn:
   185 00000169 488B3C25[38000000]          mov     rdi, [.pshape]
   186 00000171 4883C704                    add     rdi, 4
   187 00000175 488B3425[30000000]          mov     rsi, [.FILE]
   188 0000017D E8C4FEFFFF                  call    InPARALLELEPIPED
   189 00000182 B801000000                  mov     rax, 1  ; Код возврата - true
   190 00000187 EB1E                        jmp     .return
   191                                  
   192                                  .tetrahedronIn:
   193 00000189 488B3C25[38000000]          mov     rdi, [.pshape]
   194 00000191 4883C704                    add     rdi, 4
   195 00000195 488B3425[30000000]          mov     rsi, [.FILE]
   196 0000019D E802FFFFFF                  call    InTETRAHEDRON
   197 000001A2 B801000000                  mov     rax, 1  ; Код возврата - true
   198                                  
   199                                  .return:
   200                                  
   201 000001A7 C9                      leave
   202 000001A8 C3                      ret
   203                                  
   204                                  ; // Ввод содержимого контейнера из указанного файла
   205                                  ; void InContainer(void *c, int *len, FILE *ifst) {
   206                                  ;     void *tmp = c;
   207                                  ;     while(!feof(ifst)) {
   208                                  ;         if(InShape(tmp, ifst)) {
   209                                  ;             tmp = tmp + shapeSize;
   210                                  ;             (*len)++;
   211                                  ;         }
   212                                  ;     }
   213                                  ; }
   214                                  global InContainer
   215                                  InContainer:
   216                                  section .bss
   217 00000044 ????????????????            .pcont  resq    1   ; адрес контейнера
   218 0000004C ????????????????            .plen   resq    1   ; адрес для сохранения числа введенных элементов
   219 00000054 ????????????????            .FILE   resq    1   ; указатель на файл
   220                                  section .text
   221 000001A9 55                      push rbp
   222 000001AA 4889E5                  mov rbp, rsp
   223                                  
   224 000001AD 48893C25[44000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   225 000001B5 48893425[4C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   226 000001BD 48891425[54000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   227                                      ; В rdi адрес начала контейнера
   228 000001C5 4831DB                      xor rbx, rbx        ; число фигур = 0
   229 000001C8 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   230                                  .loop:
   231                                      ; сохранение рабочих регистров
   232 000001CB 57                          push rdi
   233 000001CC 53                          push rbx
   234                                  
   235 000001CD 488B3425[54000000]          mov     rsi, [.FILE]
   236 000001D5 B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   237 000001DA E80BFFFFFF                  call    InShape     ; ввод фигуры
   238 000001DF 4883F800                    cmp rax, 0          ; проверка успешности ввода
   239 000001E3 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   240                                  
   241 000001E5 5B                          pop rbx
   242 000001E6 48FFC3                      inc rbx
   243                                  
   244 000001E9 5F                          pop rdi
   245 000001EA 4883C720                    add rdi, 32             ; адрес следующей фигуры
   246                                  
   247 000001EE EBDB                        jmp .loop
   248                                  .return:
   249 000001F0 488B0425[4C000000]          mov rax, [.plen]    ; перенос указателя на длину
   250 000001F8 8918                        mov [rax], ebx      ; занесение длины
   251 000001FA C9                      leave
   252 000001FB C3                      ret
   253                                  
