     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  
     5                                  extern SPHERE
     6                                  extern PARALLELEPIPED
     7                                  
     8                                  ;----------------------------------------------
     9                                  ; // Ввод параметров прямоугольника из файла
    10                                  ; void InSPHERE(void *r, FILE *ifst) {
    11                                  ;     fscanf(ifst, "%d%d", (int*)r, (int*)(r+intSize));
    12                                  ; }
    13                                  global InSPHERE
    14                                  InSPHERE:
    15                                  section .data
    16 00000000 2564256400                  .infmt db "%d%d",0
    17                                  section .bss
    18 00000000 ????????????????            .FILE   resq    1   ; временное хранение указателя на файл
    19 00000008 ????????????????            .prect  resq    1   ; адрес прямоугольника
    20                                  section .text
    21 00000000 55                      push rbp
    22 00000001 4889E5                  mov rbp, rsp
    23                                  
    24                                      ; Сохранение принятых аргументов
    25 00000004 48893C25[08000000]          mov     [.prect], rdi          ; сохраняется адрес прямоугольника
    26 0000000C 48893425[00000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    27                                  
    28                                      ; Ввод прямоугольника из файла
    29 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    30 0000001C 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    30 0000001E [0000000000000000] 
    31 00000026 488B1425[08000000]          mov     rdx, [.prect]       ; &x
    32 0000002E 488B0C25[08000000]          mov     rcx, [.prect]
    33 00000036 4883C104                    add     rcx, 4              ; &y = &x + 4
    34 0000003A B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    35 0000003F E8(00000000)                call    fscanf
    36                                  
    37 00000044 C9                      leave
    38 00000045 C3                      ret
    39                                  
    40                                  ; // Ввод параметров треугольника из файла
    41                                  ; void InPARALLELEPIPED(void *t, FILE *ifst) {
    42                                  ;     fscanf(ifst, "%d%d%d", (int*)t,
    43                                  ;            (int*)(t+intSize), (int*)(t+2*intSize));
    44                                  ; }
    45                                  global InPARALLELEPIPED
    46                                  InPARALLELEPIPED:
    47                                  section .data
    48 00000005 256425642564256400          .infmt db "%d%d%d%d",0
    49                                  section .bss
    50 00000010 ????????????????            .FILE   resq    1   ; временное хранение указателя на файл
    51 00000018 ????????????????            .trian  resq    1   ; адрес треугольника
    52                                  section .text
    53 00000046 55                      push rbp
    54 00000047 4889E5                  mov rbp, rsp
    55                                  
    56                                      ; Сохранение принятых аргументов
    57 0000004A 48893C25[18000000]          mov     [.trian], rdi          ; сохраняется адрес треугольника
    58 00000052 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    59                                  
    60                                      ; Ввод треугольника из файла
    61 0000005A 488B3C25[10000000]          mov     rdi, [.FILE]
    62 00000062 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    62 00000064 [0500000000000000] 
    63                                  
    64 0000006C 488B1425[18000000]          mov     rdx, [.trian]       ; &a
    65                                  
    66 00000074 488B0C25[18000000]          mov     rcx, [.trian]
    67 0000007C 4883C104                    add     rcx, 4              ; &b = &a + 4
    68                                  
    69 00000080 4C8B0425[18000000]          mov     r8, [.trian]
    70 00000088 4983C008                    add     r8, 8               ; &c = &a + 8
    71                                  
    72 0000008C 4C8B0C25[18000000]          mov     r9, [.trian]
    73 00000094 4983C10C                    add     r9, 12
    74                                      ;movsd     xmm1, [.trian]
    75                                      ;add     xmm1, 12
    76 00000098 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    77 0000009D E8(00000000)                call    fscanf
    78                                  
    79 000000A2 C9                      leave
    80 000000A3 C3                      ret
    81                                  
    82                                  ; // Ввод параметров обобщенной фигуры из файла
    83                                  ; int InShape(void *s, FILE *ifst) {
    84                                  ;     int k;
    85                                  ;     fscanf(ifst, "%d", &k);
    86                                  ;     switch(k) {
    87                                  ;         case 1:
    88                                  ;             *((int*)s) = SPHERE;
    89                                  ;             InSPHERE(s+intSize, ifst);
    90                                  ;             return 1;
    91                                  ;         case 2:
    92                                  ;             *((int*)s) = PARALLELEPIPED;
    93                                  ;             InPARALLELEPIPED(s+intSize, ifst);
    94                                  ;             return 1;
    95                                  ;         default:
    96                                  ;             return 0;
    97                                  ;     }
    98                                  ; }
    99                                  global InShape
   100                                  InShape:
   101                                  section .data
   102 0000000E 256400                      .tagFormat   db      "%d",0
   103 00000011 5461672069733A2025-         .tagOutFmt   db     "Tag is: %d",10,0
   103 0000001A 640A00             
   104                                  section .bss
   105 00000020 ????????????????            .FILE       resq    1   ; временное хранение указателя на файл
   106 00000028 ????????????????            .pshape     resq    1   ; адрес фигуры
   107 00000030 ????????                    .shapeTag   resd    1   ; признак фигуры
   108                                  section .text
   109 000000A4 55                      push rbp
   110 000000A5 4889E5                  mov rbp, rsp
   111                                  
   112                                      ; Сохранение принятых аргументов
   113 000000A8 48893C25[28000000]          mov     [.pshape], rdi          ; сохраняется адрес фигуры
   114 000000B0 48893425[20000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   115                                  
   116                                      ; чтение признака фигуры и его обработка
   117 000000B8 488B3C25[20000000]          mov     rdi, [.FILE]
   118 000000C0 48BE-                       mov     rsi, .tagFormat
   118 000000C2 [0E00000000000000] 
   119 000000CA 488B1425[28000000]          mov     rdx, [.pshape]      ; адрес начала фигуры (ее признак)
   120 000000D2 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   121 000000D5 E8(00000000)                call    fscanf
   122                                  
   123                                      ; Тестовый вывод признака фигуры
   124                                      ;mov     rdi, .tagOutFmt
   125                                      ;mov     rax, [.pshape]
   126                                      ;mov     esi, [rax]
   127                                      ;call    printf
   128                                  
   129 000000DA 488B0C25[28000000]          mov rcx, [.pshape]          ; загрузка адреса начала фигуры
   130 000000E2 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   131 000000E4 3B0425[00000000]            cmp eax, [SPHERE]
   132 000000EB 740D                        je .sphereIn
   133 000000ED 3B0425[00000000]            cmp eax, [PARALLELEPIPED]
   134 000000F4 7424                        je .trianIn
   135 000000F6 31C0                        xor eax, eax    ; Некорректный признак - обнуление кода возврата
   136 000000F8 EB3E                        jmp     .return
   137                                  .sphereIn:
   138                                      ; Ввод прямоугольника
   139 000000FA 488B3C25[28000000]          mov     rdi, [.pshape]
   140 00000102 4883C704                    add     rdi, 4
   141 00000106 488B3425[20000000]          mov     rsi, [.FILE]
   142 0000010E E8EDFEFFFF                  call    InSPHERE
   143 00000113 B801000000                  mov     rax, 1  ; Код возврата - true
   144 00000118 EB1E                        jmp     .return
   145                                  .trianIn:
   146                                      ; Ввод треугольника
   147 0000011A 488B3C25[28000000]          mov     rdi, [.pshape]
   148 00000122 4883C704                    add     rdi, 4
   149 00000126 488B3425[20000000]          mov     rsi, [.FILE]
   150 0000012E E813FFFFFF                  call    InPARALLELEPIPED
   151 00000133 B801000000                  mov     rax, 1  ; Код возврата - true
   152                                  .return:
   153                                  
   154 00000138 C9                      leave
   155 00000139 C3                      ret
   156                                  
   157                                  ; // Ввод содержимого контейнера из указанного файла
   158                                  ; void InContainer(void *c, int *len, FILE *ifst) {
   159                                  ;     void *tmp = c;
   160                                  ;     while(!feof(ifst)) {
   161                                  ;         if(InShape(tmp, ifst)) {
   162                                  ;             tmp = tmp + shapeSize;
   163                                  ;             (*len)++;
   164                                  ;         }
   165                                  ;     }
   166                                  ; }
   167                                  global InContainer
   168                                  InContainer:
   169                                  section .bss
   170 00000034 ????????????????            .pcont  resq    1   ; адрес контейнера
   171 0000003C ????????????????            .plen   resq    1   ; адрес для сохранения числа введенных элементов
   172 00000044 ????????????????            .FILE   resq    1   ; указатель на файл
   173                                  section .text
   174 0000013A 55                      push rbp
   175 0000013B 4889E5                  mov rbp, rsp
   176                                  
   177 0000013E 48893C25[34000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   178 00000146 48893425[3C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   179 0000014E 48891425[44000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   180                                      ; В rdi адрес начала контейнера
   181 00000156 4831DB                      xor rbx, rbx        ; число фигур = 0
   182 00000159 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   183                                  .loop:
   184                                      ; сохранение рабочих регистров
   185 0000015C 57                          push rdi
   186 0000015D 53                          push rbx
   187                                  
   188 0000015E 488B3425[44000000]          mov     rsi, [.FILE]
   189 00000166 B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   190 0000016B E834FFFFFF                  call    InShape     ; ввод фигуры
   191 00000170 4883F800                    cmp rax, 0          ; проверка успешности ввода
   192 00000174 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   193                                  
   194 00000176 5B                          pop rbx
   195 00000177 48FFC3                      inc rbx
   196                                  
   197 0000017A 5F                          pop rdi
   198 0000017B 4883C720                    add rdi, 32             ; адрес следующей фигуры
   199                                  
   200 0000017F EBDB                        jmp .loop
   201                                  .return:
   202 00000181 488B0425[3C000000]          mov rax, [.plen]    ; перенос указателя на длину
   203 00000189 8918                        mov [rax], ebx      ; занесение длины
   204 0000018B C9                      leave
   205 0000018C C3                      ret
   206                                  
